server {
  # This is the default server if no other server_name is matched
  listen 80 default_server;

  # By default drop all connections that don't have "Host" header
  server_name "";
  return 444;
}

server {
  listen      80;
  server_name localhost web;
  root /usr/run/root/;
  access_log  /var/log/nginx/access.log;
  error_log   /var/log/nginx/error.log;

  location /api/ {
    proxy_pass_header Server;
    proxy_set_header Host $http_host;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_redirect off;
    #proxy_intercept_errors on;
    proxy_pass http://api:5858;
    rewrite ^/api/(.*)$  /$1 break;
  }

  location / {
    proxy_pass_header Server;
    proxy_set_header Host $http_host;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_redirect off;
    proxy_intercept_errors on;
    proxy_pass http://chill:5000;
    #rewrite ^/site/(.*)$  /$1 break;
  }

  # Because "location / { proxy_pass ... }" is set
  location = /humans.txt {}
  location = /robots.txt {}
  location = /favicon.ico {}

  location /stats/ {
    root   /usr/run/stats/www/;
    index  awstats.{{ cookiecutter.site_domain }}.html;
    auth_basic            "Restricted";
    auth_basic_user_file  /usr/run/stats/.htpasswd;
    access_log /var/log/nginx/access.awstats.log;
    error_log /var/log/nginx/error.awstats.log;
    rewrite ^/stats/(.*)$  /$1 break;
  }

  error_page 404 /notfound/;
}
